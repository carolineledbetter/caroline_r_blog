---
title: map instead of rowwise
author: Caroline Ledbetter
date: '2019-12-13'
slug: map-instead-of-rowwise
categories:
  - R
tags:
  - purr
  - tidyverse
  
comment: true
---

I recently came across 
[this post on alternatives to rowwise](https://community.rstudio.com/t/dplyr-alternatives-to-rowwise/8071) 
and it got me thinking about the situations where I tend to use `rowwise()` and 
how I might use alternatives. One of the first things I realized is that 
nearly every instance where I use `rowwise()` could be replaced by 
`group_by(id_column)`. For someone who always found the `apply` family fairly 
straightforward and intuitive - I must confess, I've struggled more with the
`purrr::map` family. They do however have a number of advantages over the 
`apply` family - namely unified syntax and the ability to specify the output 
type. I also really like the ability to bind data frame 
rows with a column for the source (`map_dfr(..., .id = 'source')`). This post 
is my attempt to think through some of the ways I can use `pmap` and 
nested columns with `map` in place of rowwise. 

# the process  
**Setup dummy data frame**   
I've set up a data frame with integer, logical and character columns because 
most of what I use `rowwise` for is testing for conditions, the presence of a 
value or numeric manipulation (sum, min, etc.).

```{r, message = F}
library(tidyverse)
```

```{r, results = 'hide'}
set.seed(1313)
dat <- tibble(!!!c(id = list(1:10), 
  int_ = replicate(3, sample.int(10), simplify = F), 
  lgl_ = replicate(3, sample(c(T, F), 10, replace = T), 
                   simplify = F), 
  chr_ = replicate(3, sample(c("A", "B", "C"), 10, replace = T), 
                   simplify = F)
), .name_repair = 'universal') %>% 
  rename_all(str_remove_all, pattern = '\\.')

```

```{r}
dat
```

**use pmap**  
`pmap` seems to be what I want when I really don't have a grouping variable, 
I want to do something rowwise even if I have multiple observations (lines) 
per id and/or I really want a vector output. `pmap` takes the column names as
the names of the arguments. 

```{r}
dat %>% 
  select(starts_with('lgl')) %>% 
  pmap_lgl(all)
```
 
In the above example for the first row pmap would correspond to:  
`all(lgl_1 = TRUE, lgl_2 = TRUE, lgl_3 = FALSE)` and thus it returns 
`FALSE`. 

It can be combined with `bind_cols` to append the vector as new column.  

```{r}
dat %>% 
  select(starts_with('int')) %>% 
  pmap_int(sum) %>% 
  bind_cols(dat, sum = .) %>% 
  select(int_1:int_3, lgl_1, sum)

dat %>% 
  select(starts_with('lgl')) %>% 
  pmap_lgl(all)  %>% 
  bind_cols(dat, all_true = .) %>% 
  select(int_1:int_2, lgl_1:lgl_3, all_true)

dat %>% 
  select(starts_with('lgl')) %>% 
  pmap_lgl(any)

```

**use nest and rowwise**  
The below examples group_by(id) and use `map`. This allows us to take advantage
of the `tidyselect::select_helpers` to group our variables.
```{r}
dat %>%
  group_by(id) %>%
   nest(int_vars = starts_with('int'), 
        lgl_vars = contains('lgl'), 
        chr_vars = c(chr_1, chr_2, chr_3)) %>% 
   mutate(sum = map_int(int_vars, sum), 
          all_t = map_lgl(lgl_vars, function(x) all(unlist(x))), 
          any_b = map_lgl(chr_vars, function(x) {
            any(map_lgl(x, ~. == 'B'))
            }), 
          any_c = map_lgl(chr_vars, function(x) any(unlist(x) == 'C')), 
          any_a = map_lgl(chr_vars, function(x) any(unlist(x) == 'A'))
          ) %>% 
  unnest(cols = c(int_vars, lgl_vars, chr_vars)) %>% 
  ungroup()
```

```{r, error = TRUE}
dat %>% 
  group_by(id) %>% 
  mutate(sum = sum(starts_with('int')))
```

```{r, error = TRUE}
dat %>% 
  group_by(id) %>% 
  mutate(sum = sum(select(starts_with('int'))))
```

We can them use
`unnest` to return our variables. 


**vs summarise**  
Lastly we can always use `group_by` and `summarise` but this becomes 
challenging if we want to do more than one "summary". 

```{r}

dat %>% 
  group_by(id) %>% 
  summarise_if(is.numeric, sum)
```

Finally, don't forget to ungroup! 
![If you bring group_by() to the party, don't forget dplyr::ungroup()](../../../images/group_by_ungroup.png)
"Artwork by ['@allison_horst'](https://github.com/allisonhorst/stats-illustrations)"


